@using _23050370_Suyog_Sigdel.Services
@using _23050370_Suyog_Sigdel.Components.Shared
@using Microsoft.Data.Sqlite
@inherits LayoutComponentBase
@inject ThemeService ThemeService
@inject NavigationManager Navigation

<div class="main-layout @ThemeService.GetThemeClass()">
    @if (IsLoginPage)
    {
        @* Login page doesn't need navbar or auth guard *@
        <div class="content">
            @Body
        </div>
    }
    else
    {
        <AuthGuard>
            <Navbar />
            <div class="content">
                @Body
            </div>
        </AuthGuard>
    }
</div>

@code {
    private bool IsLoginPage => Navigation.Uri.Contains("/login");

    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += StateHasChanged;
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // SQLite database path
            var dbPath = Path.Combine(FileSystem.AppDataDirectory, "journals.db");
            Console.WriteLine($"SQLite DB Path: {dbPath}");

            // Open a test connection
            using var connection = new SqliteConnection($"Data Source={dbPath}");
            await connection.OpenAsync();
            Console.WriteLine("✅ Connected to SQLite successfully!");
            await connection.CloseAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("❌ SQLite connection failed:");
            Console.WriteLine(ex.Message);
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}