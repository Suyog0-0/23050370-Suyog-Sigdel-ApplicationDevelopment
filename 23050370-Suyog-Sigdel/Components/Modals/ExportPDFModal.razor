@inject _23050370_Suyog_Sigdel.Services.PDFExportService.PDFExportService PDFExportService
@inject _23050370_Suyog_Sigdel.Services.ThemeService ThemeService

<div class="modal-backdrop" style="@(_show ? "display:flex" : "display:none")">
    <div class="modal-content export-modal @ThemeService.GetThemeClass()">
        <div class="modal-header">
            <div class="header-content">
                <i class="fas fa-file-pdf"></i>
                <span>Export to PDF</span>
            </div>
            <button class="modal-close" @onclick="Close">Ã—</button>
        </div>
        
        <div class="modal-body">
            @if (!exportSuccess)
            {
                <p class="modal-description">Select a date range to export your journal entries</p>
                
                <div class="date-inputs">
                    <div class="input-group">
                        <label>From Date</label>
                        <input type="date" 
                               class="date-input" 
                               @bind="startDate" 
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>
                    
                    <div class="input-group">
                        <label>To Date</label>
                        <input type="date" 
                               class="date-input" 
                               @bind="endDate" 
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }
                
                @if (isExporting)
                {
                    <div class="export-progress">
                        <div class="spinner"></div>
                        <p>Exporting PDFs...</p>
                    </div>
                }
            }
            else
            {
                <div class="success-content">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Export Successful!</h3>
                    <p class="success-message">
                        Exported <strong>@entryCount</strong> @(entryCount == 1 ? "entry" : "entries") to PDF successfully.
                    </p>
                    
                    <div class="file-info">
                        <i class="fas fa-folder file-icon"></i>
                        <div class="file-details">
                            <strong class="file-name">@Path.GetFileName(exportedFolderPath)</strong>
                            <div class="file-location-text">@exportedFolderPath</div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <div class="modal-actions">
            @if (!exportSuccess)
            {
                <button class="export-btn" @onclick="ExportToPdf" disabled="@isExporting">
                    <i class="fas fa-download"></i>
                    Export
                </button>
                <button class="cancel-btn" @onclick="Close" disabled="@isExporting">
                    Cancel
                </button>
            }
            else
            {
                <!--  <button class="open-btn" @onclick="OpenFolder">
                    <i class="fas fa-folder-open"></i>
                    Open Folder
                </button> -->
                <button class="done-btn" @onclick="Close">
                    Done
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] 
    public EventCallback OnClose { get; set; }

    private bool _show = false;
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    private string errorMessage = string.Empty;
    private bool isExporting = false;
    private bool exportSuccess = false;
    private string exportedFolderPath = string.Empty;
    private int entryCount = 0;

    public void Show()
    {
        _show = true;
        startDate = DateTime.Today.AddMonths(-1);
        endDate = DateTime.Today;
        errorMessage = string.Empty;
        exportSuccess = false;
        exportedFolderPath = string.Empty;
        entryCount = 0;
        StateHasChanged();
    }

    public void Hide()
    {
        _show = false;
        StateHasChanged();
    }

    private async Task Close()
    {
        _show = false;
        await OnClose.InvokeAsync();
    }

    private async Task ExportToPdf()
    {
        errorMessage = string.Empty;

        // Validate dates
        if (startDate > endDate)
        {
            errorMessage = "Start date must be before end date";
            Console.WriteLine("[Export Modal] Error: Start date after end date");
            return;
        }

        if (endDate > DateTime.Today)
        {
            errorMessage = "End date cannot be in the future";
            Console.WriteLine("[Export Modal] Error: End date in future");
            return;
        }

        Console.WriteLine($"[Export Modal] Start Date (DateTime): {startDate}");
        Console.WriteLine($"[Export Modal] End Date (DateTime): {endDate}");

        isExporting = true;
        StateHasChanged();

        try
        {
            var startDateOnly = DateOnly.FromDateTime(startDate);
            var endDateOnly = DateOnly.FromDateTime(endDate);

            Console.WriteLine($"[Export Modal] Start Date (DateOnly): {startDateOnly}");
            Console.WriteLine($"[Export Modal] End Date (DateOnly): {endDateOnly}");
            Console.WriteLine($"[Export Modal] Calling export service...");

            var (count, folderPath) = await PDFExportService.ExportByDateRangeAsync(startDateOnly, endDateOnly);

            Console.WriteLine($"[Export Modal] Service returned - Count: {count}, Path: {folderPath}");

            if (count == 0 || string.IsNullOrEmpty(folderPath))
            {
                errorMessage = "No entries found in the selected date range";
                Console.WriteLine("[Export Modal] No entries found");
                isExporting = false;
                return;
            }

            entryCount = count;
            exportedFolderPath = folderPath;
            exportSuccess = true;
            isExporting = false;
            Console.WriteLine($"[Export Modal] Export successful! {count} entries exported");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
            Console.WriteLine($"[Export Modal] Exception: {ex.Message}");
            Console.WriteLine($"[Export Modal] Stack: {ex.StackTrace}");
            isExporting = false;
            StateHasChanged();
        }
    }

    <!-- private async Task OpenFolder()
    {
        try
        {
            await Launcher.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(exportedFolderPath)
            });
        }
        catch
        {
            // If opening folder fails, try opening the directory
            try
            {
                var firstFile = Directory.GetFiles(exportedFolderPath).FirstOrDefault();
                if (firstFile != null)
                {
                    await Launcher.OpenAsync(new OpenFileRequest
                    {
                        File = new ReadOnlyFile(firstFile)
                    });
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Could not open folder: {ex.Message}";
                StateHasChanged();
            }
        }
    } -->
}
