@inject _23050370_Suyog_Sigdel.Services.PDFExportService.PDFExportService PDFExportService
@inject _23050370_Suyog_Sigdel.Services.ThemeService ThemeService

<div class="modal-backdrop" style="@(_show ? "display:flex" : "display:none")">
    <div class="modal-content export-modal @ThemeService.GetThemeClass()">
        <div class="modal-header">
            <div class="header-content">
                <i class="fas fa-file-pdf"></i>
                <span>Export to PDF</span>
            </div>
            <button class="modal-close" @onclick="Close">Ã—</button>
        </div>
        
        <div class="modal-body">
            @if (!exportSuccess)
            {
                <p class="modal-description">Select a date range to export your journal entries</p>
                
                <div class="date-inputs">
                    <div class="input-group">
                        <label>From Date</label>
                        <input type="date" 
                               class="date-input" 
                               @bind="startDate" 
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>
                    
                    <div class="input-group">
                        <label>To Date</label>
                        <input type="date" 
                               class="date-input" 
                               @bind="endDate" 
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }
                
                @if (isExporting)
                {
                    <div class="export-progress">
                        <div class="spinner"></div>
                        <p>Generating PDF...</p>
                    </div>
                }
            }
            else
            {
                <div class="success-content">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Export Successful!</h3>
                    <p class="success-message">Your journal has been exported to PDF successfully.</p>
                    
                    <div class="file-info">
                        <i class="fas fa-file-pdf file-icon"></i>
                        <div class="file-details">
                            <strong class="file-name">@Path.GetFileName(exportedFilePath)</strong>
                            <div class="file-location-text">@exportedFilePath</div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <div class="modal-actions">
            @if (!exportSuccess)
            {
                <button class="export-btn" @onclick="ExportToPdf" disabled="@isExporting">
                    <i class="fas fa-download"></i>
                    Export
                </button>
                <button class="cancel-btn" @onclick="Close" disabled="@isExporting">
                    Cancel
                </button>
            }
            else
            {
                <button class="open-btn" @onclick="OpenFile">
                    <i class="fas fa-external-link-alt"></i>
                    Open PDF
                </button>
                <button class="done-btn" @onclick="Close">
                    Done
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] 
    public EventCallback OnClose { get; set; }

    private bool _show = false;
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    private string errorMessage = string.Empty;
    private bool isExporting = false;
    private bool exportSuccess = false;
    private string exportedFilePath = string.Empty;

    public void Show()
    {
        _show = true;
        startDate = DateTime.Today.AddMonths(-1);
        endDate = DateTime.Today;
        errorMessage = string.Empty;
        exportSuccess = false;
        exportedFilePath = string.Empty;
        StateHasChanged();
    }

    public void Hide()
    {
        _show = false;
        StateHasChanged();
    }

    private async Task Close()
    {
        _show = false;
        await OnClose.InvokeAsync();
    }

    private async Task ExportToPdf()
    {
        errorMessage = string.Empty;

        // Validate dates
        if (startDate > endDate)
        {
            errorMessage = "Start date must be before end date";
            return;
        }

        if (endDate > DateTime.Today)
        {
            errorMessage = "End date cannot be in the future";
            return;
        }

        isExporting = true;
        StateHasChanged();

        try
        {
            var startDateOnly = DateOnly.FromDateTime(startDate);
            var endDateOnly = DateOnly.FromDateTime(endDate);

            var pdfPath = await PDFExportService.ExportEntriesByDateRangeAsync(startDateOnly, endDateOnly);

            if (string.IsNullOrEmpty(pdfPath))
            {
                errorMessage = "No entries found in the selected date range";
                isExporting = false;
                return;
            }

            exportedFilePath = pdfPath;
            exportSuccess = true;
            isExporting = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task OpenFile()
    {
        try
        {
            // Open the PDF file directly
            await Launcher.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(exportedFilePath)
            });
        }
        catch (Exception ex)
        {
            errorMessage = $"Could not open PDF: {ex.Message}";
            StateHasChanged();
        }
    }
}