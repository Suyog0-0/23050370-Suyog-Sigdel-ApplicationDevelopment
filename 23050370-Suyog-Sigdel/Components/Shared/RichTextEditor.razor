@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div id="@editorId" class="quill-editor"></div>

@code {
    private string editorId = $"quill-{Guid.NewGuid():N}";
    private DotNetObjectReference<RichTextEditor>? dotNetRef;
    private bool isInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        Console.WriteLine($"[RTE] Rendering editor {editorId}");

        dotNetRef = DotNetObjectReference.Create(this);

        try
        {
            isInitialized = await JSRuntime.InvokeAsync<bool>(
                "initQuill",
                editorId,
                dotNetRef
            );

            Console.WriteLine($"[RTE] Quill initialized = {isInitialized}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("[RTE] JS init error: " + ex.Message);
        }
    }

    [JSInvokable]
    public Task HandleContentChange(string html)
    {
        Console.WriteLine("[RTE] Content length:", html?.Length);
        return Task.CompletedTask;
    }

    public async Task<string> GetHTML()
    {
        Console.WriteLine("[RTE] GetHTML called");

        if (!isInitialized) return string.Empty;

        return await JSRuntime.InvokeAsync<string>(
            "getQuillContent",
            editorId
        );
    }

    public async Task LoadHTMLContent(string html)
    {
        Console.WriteLine("[RTE] LoadHTMLContent");

        if (!isInitialized)
            await Task.Delay(100);

        await JSRuntime.InvokeVoidAsync(
            "setQuillContent",
            editorId,
            html
        );
    }

    public async Task Clear()
    {
        Console.WriteLine("[RTE] Clear called");

        if (isInitialized)
            await JSRuntime.InvokeVoidAsync("clearQuill", editorId);
    }

    public async ValueTask DisposeAsync()
    {
        Console.WriteLine("[RTE] Dispose");

        dotNetRef?.Dispose();
        await JSRuntime.InvokeVoidAsync(
            "eval",
            $"delete window.quillEditors['{editorId}']"
        );
    }
}
