@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div id="@editorId" class="quill-wrapper"></div>

@code {
    private string editorId = $"quill-{Guid.NewGuid():N}";
    private DotNetObjectReference<RichTextEditor>? dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        dotNetRef = DotNetObjectReference.Create(this);

        try
        {
            await JSRuntime.InvokeVoidAsync("initQuillEditor", editorId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RTE Error]: {ex.Message}");
        }
    }

    [JSInvokable]
    public Task OnContentChange(string html)
    {
        return Task.CompletedTask;
    }

    public async Task<string> GetHTML()
    {
        try
        {
            return await JSRuntime.InvokeAsync<string>("getQuillHTML", editorId);
        }
        catch
        {
            return string.Empty;
        }
    }

    public async Task LoadHTMLContent(string html)
    {
        try
        {
            await Task.Delay(150); // Wait for editor to be ready
            await JSRuntime.InvokeVoidAsync("setQuillHTML", editorId, html ?? "");
            await Task.Delay(50); // Allow history clear to complete
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RTE Load Error]: {ex.Message}");
        }
    }

    public async Task Clear()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("clearQuillEditor", editorId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RTE Clear Error]: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyQuillEditor", editorId);
            dotNetRef?.Dispose();
        }
        catch { }
    }
}