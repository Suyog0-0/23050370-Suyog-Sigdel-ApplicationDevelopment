@page "/journals"
@inject _23050370_Suyog_Sigdel.Services.JournalService JournalService
@inject _23050370_Suyog_Sigdel.Services.SearchService SearchService
@inject NavigationManager Navigation
@using _23050370_Suyog_Sigdel.Components.Modals
@using _23050370_Suyog_Sigdel.Components.Shared
@implements IDisposable

<div class="journal-container">
    <div class="journal-header">
        <button class="back-button" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>My Journals</h1>
        <button class="add-button" @onclick="ShowAddModal" title="Add Entry">
            <i class="fas fa-plus"></i>
            Add Entry
        </button>
        <button class="export-button" @onclick="ShowExportModal" title="Export to PDF">
            <i class="fas fa-file-pdf"></i>
            Export PDF
        </button>
    </div>

    @if (journals == null)
    {
        <div class="status">Loading journals...</div>
    }
    else if (!FilteredJournals.Any())
    {
        <div class="empty-state">
            @if (!string.IsNullOrEmpty(SearchService.SearchTerm))
            {
                <text>No journals found matching "@SearchService.SearchTerm"</text>
            }
            else
            {
                <text>No journal entries found.</text>
            }
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(SearchService.SearchTerm))
        {
            <div class="search-info">
                @FilteredJournals.Count @(FilteredJournals.Count == 1 ? "entry" : "entries") found for "@SearchService.SearchTerm"
            </div>
        }

        <div class="entries-container">
            @foreach (var entry in PaginatedJournals)
            {
                <JournalCard Entry="@entry"
                             OnEdit="@(() => ShowEditModal(entry))"
                             OnDelete="@(() => ShowDeleteModal(entry.Id))" />
            }
        </div>

        <Pagination CurrentPage="@currentPage"
                    TotalPages="@TotalPages"
                    OnPageChanged="@GoToPage" />
    }

    <ConfirmDeleteModal @ref="deleteModal" OnClose="OnDeleteModalClose" />
    <ErrorModal @ref="errorModal" Message="@errorMessage" OnClose="OnErrorModalClose" />
    <ExportPDFModal @ref="exportModal" OnClose="OnExportModalClose" />
    <EditJournalModal @ref="editModal" OnClose="OnEditModalClose" />
    <AddJournalModal @ref="addModal" OnClose="OnAddModalClose" OnError="OnAddError" />
</div>

@code {
    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel>? journals;
    private ConfirmDeleteModal? deleteModal;
    private ErrorModal? errorModal;
    private ExportPDFModal? exportModal;
    private EditJournalModal? editModal;
    private AddJournalModal? addModal;
    private int? deleteEntryId;
    private string errorMessage = string.Empty;
    private int? editingEntryId; 
    


    // Pagination variables
    private int pageSize = 5;
    private int currentPage = 1;

    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel> FilteredJournals
    {
        get
        {
            if (journals == null) return new List<_23050370_Suyog_Sigdel.Models.JournalEntryModel>();

            if (string.IsNullOrWhiteSpace(SearchService.SearchTerm))
                return journals;

            var searchTerm = SearchService.SearchTerm.ToLower();
            return journals.Where(j =>
                j.Title.ToLower().Contains(searchTerm) ||
                j.Content.ToLower().Contains(searchTerm) ||
                j.EntryDay.ToString().Contains(searchTerm) ||
                j.Tags.Any(t => t.Name.ToLower().Contains(searchTerm)) ||
                j.PrimaryMood.ToLower().Contains(searchTerm) ||
                (j.SecondaryMood1?.ToLower().Contains(searchTerm) ?? false) ||
                (j.SecondaryMood2?.ToLower().Contains(searchTerm) ?? false)
            ).ToList();
        }
    }

    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel> PaginatedJournals
    {
        get
        {
            return FilteredJournals
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private int TotalPages => (int)Math.Ceiling(FilteredJournals.Count / (double)pageSize);

    private void GoToPage(int page)
    {
        currentPage = page;
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadJournals();
        SearchService.OnSearchChanged += OnSearchChanged;
    }

    private void OnSearchChanged()
    {
        currentPage = 1;
        StateHasChanged();
    }

    private async Task LoadJournals()
    {
        journals = await JournalService.GetEntriesAsync();
        currentPage = 1;
    }

    // ────────────────────────────────────────────────────────
    // MODAL HANDLERS
    // ────────────────────────────────────────────────────────
    private async Task ShowAddModal()
    {
        if (addModal != null)
        {
            await addModal.TryShow(async () =>
            {
                var today = DateOnly.FromDateTime(DateTime.Now);
                var todayEntry = await JournalService.GetEntryByDateAsync(today);
                return todayEntry != null;
            });
        }
    }

    private void OnAddError(string message)
    {
        errorMessage = message;
        errorModal?.Show();
    }

    private async Task OnAddModalClose(bool saved)
    {
        if (saved && addModal != null)
        {
            var title = addModal.GetTitle();
            var content = await addModal.GetContent();
            var tags = addModal.GetSelectedTags();
            var primaryMood = addModal.GetPrimaryMood();
            var secondaryMood1 = addModal.GetSecondaryMood1();
            var secondaryMood2 = addModal.GetSecondaryMood2();

            await JournalService.AddEntryAsync(title, content, tags, primaryMood, secondaryMood1, secondaryMood2);
            await LoadJournals();
        }
    }

    
    private async Task ShowEditModal(_23050370_Suyog_Sigdel.Models.JournalEntryModel entry)
    {
        editingEntryId = entry.Id;  // Store the ID being edited
        if (editModal != null)
        {
            await editModal.ShowAsync(entry);
        }
    }

    
    
    
    
    
    
    private async Task OnEditModalClose(bool saved)
        {
            if (!saved || editModal == null || !editingEntryId.HasValue)
                return;
            

            var title = editModal.GetTitle();
            var content = await editModal.GetContent();
            var tags = editModal.GetSelectedTags();
            var primaryMood = editModal.GetPrimaryMood();
            var secondaryMood1 = editModal.GetSecondaryMood1();
            var secondaryMood2 = editModal.GetSecondaryMood2();
            

            await JournalService.UpdateEntryByIdAsync(
                editingEntryId.Value,
                title,
                content,
                tags,
                primaryMood,
                secondaryMood1,
                secondaryMood2
            );

            await LoadJournals();
            editingEntryId = null;
        }


    
    
    
    
    
    
    
    private void ShowDeleteModal(int id)
    {
        deleteEntryId = id;
        deleteModal?.Show();
    }

    private async Task OnDeleteModalClose(bool confirmed)
    {
        if (confirmed && deleteEntryId.HasValue)
        {
            await JournalService.DeleteEntryAsync(deleteEntryId.Value);
            await LoadJournals();
        }
        deleteEntryId = null;
    }

    private void OnErrorModalClose()
    {
        errorMessage = string.Empty;
    }

    private void ShowExportModal()
    {
        exportModal?.Show();
    }

    private void OnExportModalClose()
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        SearchService.OnSearchChanged -= OnSearchChanged;
    }
}
