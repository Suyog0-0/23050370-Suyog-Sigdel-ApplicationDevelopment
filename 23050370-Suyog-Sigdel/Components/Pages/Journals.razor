@page "/journals"
@inject _23050370_Suyog_Sigdel.Services.JournalService JournalService
@inject _23050370_Suyog_Sigdel.Services.SearchService SearchService
@using _23050370_Suyog_Sigdel.Components.Modals
@implements IDisposable

<div class="journal-container">
    <h1>My Journals</h1>

    <div class="input-section">
        <textarea 
            class="journal-input" 
            @bind="newEntryContent" 
            placeholder="Write your thoughts here..." 
            rows="4">
        </textarea>
        <div class="button-row">
            <button class="btn-add" @onclick="AddEntry">Add Today</button>
            <button class="btn-update" @onclick="UpdateEntry">Update Today</button>
        </div>
    </div>

    @if (journals == null)
    {
        <div class="status">Loading journals...</div>
    }
    else if (!FilteredJournals.Any())
    {
        <div class="empty-state">
            @if (!string.IsNullOrEmpty(SearchService.SearchTerm))
            {
                <text>No journals found matching "@SearchService.SearchTerm"</text>
            }
            else
            {
                <text>No journal entries found.</text>
            }
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(SearchService.SearchTerm))
        {
            <div class="search-info">
                @FilteredJournals.Count @(FilteredJournals.Count == 1 ? "entry" : "entries") found for "@SearchService.SearchTerm"
            </div>
        }

        <div class="entries-container">
            @foreach (var entry in FilteredJournals)
            {
                <div class="journal-card">
                    <div class="entry-header">
                        <span class="date">@entry.EntryDay.ToDateTime(TimeOnly.MinValue).ToString("dddd, MMMM dd, yyyy")</span>
                        <button class="btn-delete" @onclick="() => ShowDeleteModal(entry.Id)">
                            Ã—
                        </button>
                    </div>
                    <div class="content">@entry.Content</div>
                </div>
            }
        </div>
    }

    <ConfirmDeleteModal @ref="deleteModal" OnClose="OnDeleteModalClose" />
    <ErrorModal @ref="errorModal" Message="@errorMessage" OnClose="OnErrorModalClose" />
</div>

@code {
    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel>? journals;
    private string newEntryContent = string.Empty;
    private ConfirmDeleteModal? deleteModal;
    private ErrorModal? errorModal;
    private int? deleteEntryId;
    private string errorMessage = string.Empty;

    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel> FilteredJournals
    {
        get
        {
            if (journals == null) return new List<_23050370_Suyog_Sigdel.Models.JournalEntryModel>();

            if (string.IsNullOrWhiteSpace(SearchService.SearchTerm))
                return journals;

            var searchTerm = SearchService.SearchTerm.ToLower();
            return journals.Where(j => 
                j.Content.ToLower().Contains(searchTerm) ||
                j.EntryDay.ToString().Contains(searchTerm)
            ).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadJournals();
        SearchService.OnSearchChanged += OnSearchChanged;
    }

    private void OnSearchChanged()
    {
        StateHasChanged();
    }

    private async Task LoadJournals() => journals = await JournalService.GetEntriesAsync();

    private async Task AddEntry()
    {
        if (string.IsNullOrWhiteSpace(newEntryContent)) 
        {
            errorMessage = "Please write something before adding an entry.";
            errorModal?.Show();
            return;
        }

        var today = DateOnly.FromDateTime(DateTime.Now);
        var todayEntry = journals?.FirstOrDefault(j => j.EntryDay == today);
        
        if (todayEntry != null)
        {
            errorMessage = "A journal entry for today already exists. Please use 'Update Today' to modify it.";
            errorModal?.Show();
            return;
        }

        await JournalService.AddEntryAsync(newEntryContent);
        newEntryContent = string.Empty;
        await LoadJournals();
    }

    private async Task UpdateEntry()
    {
        if (string.IsNullOrWhiteSpace(newEntryContent))
        {
            errorMessage = "Please write something before updating an entry.";
            errorModal?.Show();
            return;
        }

        await JournalService.UpdateEntryAsync(newEntryContent);
        newEntryContent = string.Empty;
        await LoadJournals();
    }

    private void ShowDeleteModal(int id)
    {
        deleteEntryId = id;
        deleteModal?.Show();
    }

    private async Task OnDeleteModalClose(bool confirmed)
    {
        if (confirmed && deleteEntryId.HasValue)
        {
            await JournalService.DeleteEntryAsync(deleteEntryId.Value);
            await LoadJournals();
        }
        deleteEntryId = null;
    }

    private void OnErrorModalClose()
    {
        errorMessage = string.Empty;
    }

    public void Dispose()
    {
        SearchService.OnSearchChanged -= OnSearchChanged;
    }
}