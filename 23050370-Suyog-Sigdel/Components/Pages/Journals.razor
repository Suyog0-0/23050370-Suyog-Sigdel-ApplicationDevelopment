@page "/journals"
@inject _23050370_Suyog_Sigdel.Services.JournalService JournalService

<h3>My Journals</h3>

<div class="journal-add">
    <input type="text" @bind="newEntryContent" placeholder="Write your journal..." />
    <button @onclick="AddEntry">Add Today</button>
    <button @onclick="UpdateEntry">Update Today</button>
</div>

@if (journals == null)
{
    <p>Loading journals...</p>
}
else if (!journals.Any())
{
    <p>No journal entries found.</p>
}
else
{
    <ul class="journal-list">
        @foreach (var entry in journals)
        {
            <li>
                <span class="journal-date">@entry.Date.ToString("yyyy-MM-dd")</span>
                <span class="journal-content">@entry.Content</span>
                <button class="delete-btn" @onclick="() => DeleteEntry(entry.Id)">Delete</button>
            </li>
        }
    </ul>
}

@code {
    private List<_23050370_Suyog_Sigdel.Models.JournalEntry>? journals;
    private string newEntryContent = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadJournals();
    }

    // ──────────────────────────────────────────────
    //      LOAD JOURNALS
    // ──────────────────────────────────────────────
    private async Task LoadJournals()
    {
        journals = await JournalService.GetEntriesAsync();
    }

    // ──────────────────────────────────────────────
    //      ADD ENTRY
    // ──────────────────────────────────────────────
    private async Task AddEntry()
    {
        if (!string.IsNullOrWhiteSpace(newEntryContent))
        {
            var today = DateOnly.FromDateTime(DateTime.UtcNow);
            var existingEntry = await JournalService.GetEntryByDateAsync(today);

            if (existingEntry == null)
            {
                await JournalService.AddOrUpdateEntryAsync(newEntryContent);
                newEntryContent = string.Empty;
                await LoadJournals();
            }
            else
            {
                Console.WriteLine("Today's entry already exists. Use Update button.");
            }
        }
    }

    // ──────────────────────────────────────────────
    //      UPDATE ENTRY
    // ──────────────────────────────────────────────
    private async Task UpdateEntry()
    {
        if (!string.IsNullOrWhiteSpace(newEntryContent))
        {
            var today = DateOnly.FromDateTime(DateTime.UtcNow);
            var existingEntry = await JournalService.GetEntryByDateAsync(today);

            if (existingEntry != null)
            {
                await JournalService.AddOrUpdateEntryAsync(newEntryContent);
                newEntryContent = string.Empty;
                await LoadJournals();
            }
            else
            {
                Console.WriteLine("No entry found for today. Use Add button first.");
            }
        }
    }

    // ──────────────────────────────────────────────
    //      DELETE ENTRY
    // ──────────────────────────────────────────────
    private async Task DeleteEntry(int id)
    {
        await JournalService.DeleteEntryAsync(id);
        await LoadJournals();
    }
}
