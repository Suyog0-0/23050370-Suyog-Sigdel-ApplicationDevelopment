@page "/journals"
@inject _23050370_Suyog_Sigdel.Services.JournalService JournalService
@inject _23050370_Suyog_Sigdel.Services.SearchService SearchService
@inject _23050370_Suyog_Sigdel.Services.TagService.TagService TagService
@inject NavigationManager Navigation
@using _23050370_Suyog_Sigdel.Components.Modals
@using _23050370_Suyog_Sigdel.Components.Shared
@implements IDisposable

<div class="journal-container">
    <div class="journal-header">
        <button class="back-button" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>My Journals</h1>
    </div>

    <div class="input-section">
        <input 
            type="text" 
            class="title-input" 
            placeholder="Enter title (optional)..." 
            @bind="titleText" />
        
        <!-- Tag Input -->
        <div class="tag-input-container">
            <input 
                type="text" 
                class="tag-input" 
                placeholder="Add tags (press Enter or comma)..." 
                @bind="currentTagInput"
                @bind:event="oninput"
                @onkeydown="HandleTagKeyPress" />
            
            <div class="tags-display">
                @foreach (var tag in selectedTags)
                {
                    <span class="tag-badge">
                        @tag
                        <button class="tag-remove" @onclick="() => RemoveTag(tag)">×</button>
                    </span>
                }
            </div>
        </div>
        
        <RichTextEditor @ref="richTextEditor" />
        
        <div class="button-row">
            @if (editingEntryId == null)
            {
                <button class="btn-add" @onclick="AddEntry">Add Today</button>
                <button class="btn-update" @onclick="UpdateEntry">Update Today</button>
            }
            else
            {
                <button class="btn-save" @onclick="SaveEdit">Save Changes</button>
                <button class="btn-cancel" @onclick="CancelEdit">Cancel</button>
            }
        </div>
    </div>

    @if (journals == null)
    {
        <div class="status">Loading journals...</div>
    }
    else if (!FilteredJournals.Any())
    {
        <div class="empty-state">
            @if (!string.IsNullOrEmpty(SearchService.SearchTerm))
            {
                <text>No journals found matching "@SearchService.SearchTerm"</text>
            }
            else
            {
                <text>No journal entries found.</text>
            }
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(SearchService.SearchTerm))
        {
            <div class="search-info">
                @FilteredJournals.Count @(FilteredJournals.Count == 1 ? "entry" : "entries") found for "@SearchService.SearchTerm"
            </div>
        }

        <div class="entries-container">
            @foreach (var entry in PaginatedJournals)
            {
                <JournalCard Entry="@entry"
                             IsEditing="@(editingEntryId == entry.Id)"
                             OnEdit="@(() => StartEdit(entry))"
                             OnDelete="@(() => ShowDeleteModal(entry.Id))" />
            }
        </div>

        <Pagination CurrentPage="@currentPage"
                    TotalPages="@TotalPages"
                    OnPageChanged="@GoToPage" />
    }

    <ConfirmDeleteModal @ref="deleteModal" OnClose="OnDeleteModalClose" />
    <ErrorModal @ref="errorModal" Message="@errorMessage" OnClose="OnErrorModalClose" />
</div>

@code {
    private RichTextEditor? richTextEditor;
    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel>? journals;
    private ConfirmDeleteModal? deleteModal;
    private ErrorModal? errorModal;
    private int? deleteEntryId;
    private int? editingEntryId;
    private string errorMessage = string.Empty;
    private string titleText = string.Empty;

    // Tag-related fields
    private string currentTagInput = string.Empty;
    private List<string> selectedTags = new();

    // Pagination variables
    private int pageSize = 5;
    private int currentPage = 1;

    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel> FilteredJournals
    {
        get
        {
            if (journals == null) return new List<_23050370_Suyog_Sigdel.Models.JournalEntryModel>();

            if (string.IsNullOrWhiteSpace(SearchService.SearchTerm))
                return journals;

            var searchTerm = SearchService.SearchTerm.ToLower();
            return journals.Where(j =>
                j.Title.ToLower().Contains(searchTerm) ||
                j.Content.ToLower().Contains(searchTerm) ||
                j.EntryDay.ToString().Contains(searchTerm) ||
                j.Tags.Any(t => t.Name.ToLower().Contains(searchTerm))
            ).ToList();
        }
    }

    private List<_23050370_Suyog_Sigdel.Models.JournalEntryModel> PaginatedJournals
    {
        get
        {
            return FilteredJournals
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private int TotalPages => (int)Math.Ceiling(FilteredJournals.Count / (double)pageSize);

    private void GoToPage(int page)
    {
        currentPage = page;
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadJournals();
        SearchService.OnSearchChanged += OnSearchChanged;
    }

    private void OnSearchChanged()
    {
        currentPage = 1;
        StateHasChanged();
    }

    private async Task LoadJournals()
    {
        journals = await JournalService.GetEntriesAsync();
        currentPage = 1;
    }

    // ────────────────────────────────────────────────────────
    // TAG HANDLING
    // ────────────────────────────────────────────────────────
    private void HandleTagKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == ",")
        {
            AddCurrentTag();
        }
    }

    private void AddCurrentTag()
    {
        var tag = currentTagInput.Trim().ToLower().Replace(",", "");
        
        if (!string.IsNullOrWhiteSpace(tag) && !selectedTags.Contains(tag))
        {
            selectedTags.Add(tag);
            currentTagInput = string.Empty;
        }
    }

    private void RemoveTag(string tag)
    {
        selectedTags.Remove(tag);
    }

    // ────────────────────────────────────────────────────────
    // JOURNAL ENTRY OPERATIONS
    // ────────────────────────────────────────────────────────
    private async Task StartEdit(_23050370_Suyog_Sigdel.Models.JournalEntryModel entry)
    {
        editingEntryId = entry.Id;
        titleText = entry.Title;
        selectedTags = entry.Tags.Select(t => t.Name).ToList();
        await richTextEditor!.LoadHTMLContent(entry.Content);
        StateHasChanged();
    }

    private async Task SaveEdit()
    {
        if (editingEntryId == null) return;

        var htmlContent = await richTextEditor!.GetHTML();

        if (string.IsNullOrWhiteSpace(htmlContent) || htmlContent == "<br>" || htmlContent == "<div><br></div>")
        {
            errorMessage = "Please write something before saving.";
            errorModal?.Show();
            return;
        }

        // Add any pending tag
        AddCurrentTag();

        await JournalService.UpdateEntryByIdAsync(editingEntryId.Value, titleText, htmlContent, selectedTags);

        await richTextEditor.Clear();
        titleText = string.Empty;
        selectedTags.Clear();
        editingEntryId = null;
        await LoadJournals();
    }

    private async Task CancelEdit()
    {
        editingEntryId = null;
        titleText = string.Empty;
        selectedTags.Clear();
        await richTextEditor!.Clear();
        StateHasChanged();
    }

    private async Task AddEntry()
    {
        var htmlContent = await richTextEditor!.GetHTML();

        if (string.IsNullOrWhiteSpace(htmlContent) || htmlContent == "<br>" || htmlContent == "<div><br></div>")
        {
            errorMessage = "Please write something before adding an entry.";
            errorModal?.Show();
            return;
        }

        var today = DateOnly.FromDateTime(DateTime.Now);
        var todayEntry = journals?.FirstOrDefault(j => j.EntryDay == today);

        if (todayEntry != null)
        {
            errorMessage = "A journal entry for today already exists. Please use 'Update Today' to modify it.";
            errorModal?.Show();
            return;
        }

        // Add any pending tag
        AddCurrentTag();

        await JournalService.AddEntryAsync(titleText, htmlContent, selectedTags);
        await richTextEditor.Clear();
        titleText = string.Empty;
        selectedTags.Clear();
        await LoadJournals();
    }

    private async Task UpdateEntry()
    {
        var htmlContent = await richTextEditor!.GetHTML();

        if (string.IsNullOrWhiteSpace(htmlContent) || htmlContent == "<br>" || htmlContent == "<div><br></div>")
        {
            errorMessage = "Please write something before updating an entry.";
            errorModal?.Show();
            return;
        }

        // Add any pending tag
        AddCurrentTag();

        await JournalService.UpdateEntryAsync(titleText, htmlContent, selectedTags);
        await richTextEditor.Clear();
        titleText = string.Empty;
        selectedTags.Clear();
        await LoadJournals();
    }

    private void ShowDeleteModal(int id)
    {
        deleteEntryId = id;
        deleteModal?.Show();
    }

    private async Task OnDeleteModalClose(bool confirmed)
    {
        if (confirmed && deleteEntryId.HasValue)
        {
            await JournalService.DeleteEntryAsync(deleteEntryId.Value);
            await LoadJournals();
        }
        deleteEntryId = null;
    }

    private void OnErrorModalClose()
    {
        errorMessage = string.Empty;
    }

    public void Dispose()
    {
        SearchService.OnSearchChanged -= OnSearchChanged;
    }
}
