@page "/dashboard"
@inject _23050370_Suyog_Sigdel.Services.JournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="dashboard">
    <div class="header">
        <button class="back-btn" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>Dashboard</h1>
    </div>
    
    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="charts">
            <div class="chart-box">
                <h3>Primary Moods</h3>
                <canvas id="moodChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>Top Tags</h3>
                <canvas id="tagsChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>All Moods</h3>
                <canvas id="frequentMoodsChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>Tag Distribution</h3>
                <canvas id="tagBreakdownChart"></canvas>
            </div>

            <div class="chart-box wide">
                <h3>Word Count (Last 7 Days)</h3>
                <canvas id="wordCountChart"></canvas>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        var entries = await JournalService.GetEntriesAsync();
        
        if (!entries.Any())
        {
            isLoading = false;
            StateHasChanged();
            return;
        }

        // Get primary moods
        var moods = entries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToList();

        var moodLabels = moods.Select(x => x.Key).ToArray();
        var moodData = moods.Select(x => x.Count).ToArray();

        // Get top tags
        var tags = entries
            .SelectMany(e => e.Tags)
            .GroupBy(t => t.Name)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToList();

        var tagLabels = tags.Select(x => x.Key).ToArray();
        var tagData = tags.Select(x => x.Count).ToArray();

        // Get all moods (including secondary)
        var allMoods = new List<string>();
        foreach (var entry in entries)
        {
            if (!string.IsNullOrEmpty(entry.PrimaryMood)) allMoods.Add(entry.PrimaryMood);
            if (!string.IsNullOrEmpty(entry.SecondaryMood1)) allMoods.Add(entry.SecondaryMood1);
            if (!string.IsNullOrEmpty(entry.SecondaryMood2)) allMoods.Add(entry.SecondaryMood2);
        }

        var frequentMoods = allMoods
            .GroupBy(m => m)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(7)
            .ToList();

        var frequentLabels = frequentMoods.Select(x => x.Key).ToArray();
        var frequentData = frequentMoods.Select(x => x.Count).ToArray();

        // Get all tags for pie chart
        var allTags = entries
            .SelectMany(e => e.Tags)
            .GroupBy(t => t.Name)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(8)
            .ToList();

        var pieLabels = allTags.Select(x => x.Key).ToArray();
        var pieData = allTags.Select(x => x.Count).ToArray();

        // Get word counts
        var last7 = entries
            .Where(e => e.EntryDay >= DateOnly.FromDateTime(DateTime.Now.AddDays(-7)))
            .OrderBy(e => e.EntryDay)
            .ToList();

        var dates = last7.Select(e => e.EntryDay.ToString("MM/dd")).ToArray();
        var words = last7.Select(e => CountWords(e.Content)).ToArray();

        isLoading = false;
        StateHasChanged();
        await Task.Delay(100);

        await JS.InvokeVoidAsync("createCharts", 
            moodLabels, moodData, 
            tagLabels, tagData, 
            frequentLabels, frequentData,
            pieLabels, pieData,
            dates, words);
    }

    private int CountWords(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return 0;
        var text = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");
        return text.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}