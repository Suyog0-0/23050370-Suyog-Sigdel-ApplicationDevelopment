@page "/dashboard"
@inject _23050370_Suyog_Sigdel.Services.JournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="dashboard">
    <div class="header">
        <button class="back-btn" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>Dashboard</h1>
    </div>
    
    <!-- Date Filter -->
    <div class="date-filter">
        <label>Filter by Date Range:</label>
        <div class="date-inputs">
            <input type="date" @bind="startDate" @bind:event="oninput" max="@DateTime.Today.ToString("yyyy-MM-dd")" />
            <span>to</span>
            <input type="date" @bind="endDate" @bind:event="oninput" max="@DateTime.Today.ToString("yyyy-MM-dd")" />
        </div>
        <button class="apply-btn" @onclick="ApplyFilter">Apply</button>
        <button class="reset-btn" @onclick="ResetFilter">Reset</button>
    </div>
    
    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (!hasData)
    {
        <p style="text-align: center; padding: 2rem; color: #7f8c8d;">No journal entries found for the selected date range.</p>
    }
    else
    {
        <div class="charts">
            <div class="chart-box">
                <h3>Primary Moods</h3>
                <canvas id="moodChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>Top Tags</h3>
                <canvas id="tagsChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>All Moods</h3>
                <canvas id="frequentMoodsChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>Tag Distribution</h3>
                <canvas id="tagBreakdownChart"></canvas>
            </div>

            <div class="chart-box wide">
                <h3>Word Count</h3>
                <canvas id="wordCountChart"></canvas>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private bool hasData = false;
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadData();
        }
    }

    private async Task ApplyFilter()
    {
        if (startDate > endDate)
        {
            return; // Invalid range
        }
        await LoadData();
    }

    private async Task ResetFilter()
    {
        startDate = DateTime.Today.AddMonths(-1);
        endDate = DateTime.Today;
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        var allEntries = await JournalService.GetEntriesAsync();
        
        // Filter entries by date range
        var entries = allEntries
            .Where(e => e.EntryDay >= DateOnly.FromDateTime(startDate) && 
                       e.EntryDay <= DateOnly.FromDateTime(endDate))
            .ToList();
        
        if (!entries.Any())
        {
            isLoading = false;
            hasData = false;
            StateHasChanged();
            return;
        }

        hasData = true;

        // Primary moods
        var moodData = entries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToList();

        var moodLabels = moodData.Any() ? moodData.Select(x => x.Key).ToArray() : new[] { "No data" };
        var moodCounts = moodData.Any() ? moodData.Select(x => x.Count).ToArray() : new[] { 0 };

        // Top tags
        var tagData = entries
            .SelectMany(e => e.Tags)
            .GroupBy(t => t.Name)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToList();

        var tagLabels = tagData.Any() ? tagData.Select(x => x.Key).ToArray() : new[] { "No tags" };
        var tagCounts = tagData.Any() ? tagData.Select(x => x.Count).ToArray() : new[] { 0 };

        // All moods
        var allMoods = new List<string>();
        foreach (var entry in entries)
        {
            if (!string.IsNullOrEmpty(entry.PrimaryMood)) allMoods.Add(entry.PrimaryMood);
            if (!string.IsNullOrEmpty(entry.SecondaryMood1)) allMoods.Add(entry.SecondaryMood1);
            if (!string.IsNullOrEmpty(entry.SecondaryMood2)) allMoods.Add(entry.SecondaryMood2);
        }

        var freqData = allMoods
            .GroupBy(m => m)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(7)
            .ToList();

        var freqLabels = freqData.Any() ? freqData.Select(x => x.Key).ToArray() : new[] { "No data" };
        var freqCounts = freqData.Any() ? freqData.Select(x => x.Count).ToArray() : new[] { 0 };

        // Tag distribution (pie)
        var pieData = entries
            .SelectMany(e => e.Tags)
            .GroupBy(t => t.Name)
            .Select(g => new { g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(8)
            .ToList();

        var pieLabels = pieData.Any() ? pieData.Select(x => x.Key).ToArray() : new[] { "No tags" };
        var pieCounts = pieData.Any() ? pieData.Select(x => x.Count).ToArray() : new[] { 0 };

        // Word counts (within date range)
        var filteredEntries = entries.OrderBy(e => e.EntryDay).ToList();

        var dates = filteredEntries.Any() ? filteredEntries.Select(e => e.EntryDay.ToString("MM/dd")).ToArray() : new[] { "No data" };
        var words = filteredEntries.Any() ? filteredEntries.Select(e => CountWords(e.Content)).ToArray() : new[] { 0 };

        isLoading = false;
        StateHasChanged();

        await JS.InvokeVoidAsync("createCharts", 
            moodLabels, moodCounts, 
            tagLabels, tagCounts, 
            freqLabels, freqCounts,
            pieLabels, pieCounts,
            dates, words);
    }

    private int CountWords(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return 0;
        var text = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");
        return text.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}
